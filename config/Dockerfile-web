# The intention of this file is to set up a local test
# envrionment of the web front-end to Distant Reader.

FROM centos:7

# set up packages
COPY config/runit.repo /etc/yum.repos.d/imeyer_runit.repo
RUN yum install -y httpd perl perl-CGI rsync runit python3 which
RUN pip3 install pipenv
# for pipenv & flask
ENV LANG=en_US.utf8

RUN mkdir -p /var/log/httpd \
        /data-disk/bin \
        /data-disk/etc \
        /data-disk/www/html/library \
        /data-disk/www/html/reader \
        /data-disk/www/html/cord \
        /data-disk/www/html/localhost \
    && chmod a+rwx /var/log/httpd \
    && ln -s /usr/bin/perl /data-disk/bin/perl

# dummy user "test", password "test"
COPY config/dummy-htpasswd /data-disk/etc/reader-htpasswd

COPY config /etc/httpd/conf/
COPY www/library /data-disk/www/html/library
COPY www/reader /data-disk/www/html/reader
COPY . /data-disk/reader-classic

RUN cd /data-disk/reader-classic/webui && pipenv install

EXPOSE 80 8080

# set up the daemon processes for supervision
RUN mkdir /service /var/log/reader
COPY config/runit/ /service 
CMD /sbin/runsvdir /service

# vim:ft=Dockerfile
